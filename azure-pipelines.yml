# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main

pool:
  vmImage: ubuntu-latest

steps:

- task: Gradle@3
  inputs:
    workingDirectory: ''
    gradleWrapperFile: 'gradlew'
    gradleOptions: '-Xmx3072m'
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: '21'
    jdkArchitectureOption: 'x64'
    publishJUnitResults: true
    testResultsFiles: '**/TEST-*.xml'
    tasks: 'build jacocoTestReport'

- task: PublishCodeCoverageResults@2
  inputs:
    summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/build/reports/jacoco/test/jacocoTestReport.xml'
    pathToSources: '$(System.DefaultWorkingDirectory)/app/src/main/java/'

- task: Gradle@3
  inputs:
    workingDirectory: ''
    gradleWrapperFile: 'gradlew'
    gradleOptions: '-Xmx3072m'
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: '21'
    jdkArchitectureOption: 'x64'
    tasks: 'showProjectInfo'

- stage: SecurityScanning
  displayName: 'Security Scanning'
  jobs:
  - job: SecurityCheck
    displayName: 'Security Check'
    pool:
      vmImage: 'ubuntu-latest'

    steps:
    # Make sure we have full git history so Gitleaks can scan commits
    - checkout: self
      fetchDepth: 0

    # (Optional) still download build artifacts if you need them later
    - task: DownloadBuildArtifacts@0
      displayName: 'Download build outputs'
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'build-outputs'
        downloadPath: '$(System.DefaultWorkingDirectory)'

    # --- Gitleaks: CredScan replacement ---
    - task: Gitleaks@3
      displayName: 'Gitleaks secret scan (CredScan replacement)'
      inputs:
        # Where to scan – normally your source repo
        scanlocation: '$(Build.SourcesDirectory)'

        # Use predefined config with CredScan rules ported in
        configtype: 'predefined'
        predefinedconfigfile: 'GitleaksUdmCombo.toml'
        # Alt: 'UDMSecretChecksv8.toml' for “pure” CredScan rules

        # Scan mode:
        # - 'smart'    -> auto-detect best mode (PR, full, etc.)
        # - 'all'      -> all commits
        # - 'directory'-> only current files (no git history)
        scanmode: 'smart'

        # Task behaviour when secrets are found
        taskfail: false                 # fail the task on findings
        taskfailonexecutionerror: true # fail if Gitleaks crashes

        # Reporting
        reportformat: 'sarif'          # works with SARIF SAST tab
        uploadresults: true
        reportartifactname: 'CodeAnalysisLogs'
        # reportfolder:  # default: agent temp
        # reportname:    # default: gitleaks-<timestamp>.sarif

        # Noise control
        redact: true                   # hide secret values in logs
        verbose: false                 # set true while tuning rules

- stage: DependencySecurity
  displayName: 'Dependency Security Scanning'
  jobs:
  - job: OWASPCheck
    steps:
    - task: dependency-check-build-task@6
      inputs:
          projectName: '$(Build.Repository.Name)'
          scanPath: '$(System.DefaultWorkingDirectory)'
          format: 'HTML'
          uploadReports: true
          uploadSARIFReport: true
          # failOnCVSS: '7' # <-- remove this line to avoid failing the job on high CVSS scores
          nvdApiKey: '592327f5-bc69-4e52-aa92-5e878647cd94S'  # Replace with your API key
          additionalArguments: >
            --disableCentral
            --disableOssIndex

- script: chmod +x gradlew