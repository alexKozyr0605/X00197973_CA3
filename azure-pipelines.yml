# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main

stages:
- stage: Build
  displayName: "Build/Test"
  jobs:
  - job: Building
    pool:
      vmImage: ubuntu-latest

    steps:
    - script: chmod +x gradlew

    - task: Gradle@3
      inputs:
        workingDirectory: ''
        gradleWrapperFile: 'gradlew'
        gradleOptions: '-Xmx3072m'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '17'
        jdkArchitectureOption: 'x64'
        publishJUnitResults: true
        testResultsFiles: '**/TEST-*.xml'
        tasks: 'clean build jacocoTestReport'

    - task: PublishCodeCoverageResults@2
      inputs:
        summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/build/reports/jacoco/test/jacocoTestReport.xml'
        pathToSources: '$(System.DefaultWorkingDirectory)/app/src/main/java/'

    # - task: Gradle@3
    #   inputs:
    #     workingDirectory: ''
    #     gradleWrapperFile: 'gradlew'
    #     gradleOptions: '-Xmx3072m'
    #     javaHomeOption: 'JDKVersion'
    #     jdkVersionOption: '21'
    #     jdkArchitectureOption: 'x64'
    #     tasks: 'showProjectInfo'

    - task: CopyFiles@2
      inputs:
        contents: 'app/build/libs/*.jar'
        targetFolder: '$(build.artifactStagingDirectory)'

    - task: PublishPipelineArtifact@1
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'drop'

    # - task: Gitleaks@3
    #   inputs:
    #     scanlocation: '$(Build.SourcesDirectory)'
    #     configtype: 'predefined'
    #     predefinedconfigfile: 'GitleaksUdmCombo.toml'
    #     reportformat: 'sarif'

- stage: Deploy
  jobs:
  - deployment: DeployJob
    pool:
      vmImage: 'ubuntu-latest'
    environment: 'CA3 Environment'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: JavaToolInstaller@0
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'drop'
              downloadPath: '$(Build.ArtifactStagingDirectory)'
          - script: |
              JAR_FILE="$(System.ArtifactsDirectory)/build-outputs/build/libs/securing-web-0.0.1-SNAPSHOT.jar"
              if [ ! -f "$JAR_FILE" ]; then
                echo "JAR file not found at: $JAR_FILE"
                ls -R $(System.ArtifactsDirectory)
                exit 1
              fi
              echo "Found JAR file: $JAR_FILE"
              
              # Find Java 21 path
              JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))
              echo "JAVA_HOME: $JAVA_HOME"
              
              # Copy JAR to a permanent location
              sudo mkdir -p /opt/springapp
              sudo cp "$JAR_FILE" /opt/springapp/app.jar
              
              # Create service file
              sudo tee /etc/systemd/system/springapp.service << EOF
              [Unit]
              Description=Spring Boot Application
              After=network.target
              
              [Service]
              Type=simple
              User=vsts
              Environment="JAVA_HOME=$JAVA_HOME"
              ExecStart=$JAVA_HOME/bin/java -jar -Dserver.address=0.0.0.0 /opt/springapp/app.jar
              Restart=always
              WorkingDirectory=/opt/springapp
              
              [Install]
              WantedBy=multi-user.target
              EOF
              
              # Start service
              sudo systemctl daemon-reload
              sudo systemctl enable springapp
              sudo systemctl start springapp
              
              # Check status and logs
              sleep 5
              sudo systemctl status springapp
              sudo journalctl -u springapp --no-pager -n 50
            displayName: 'Deploy Spring Boot app as service'
          - task: JMeterInstaller@0
            inputs:
              jmeterVersion: '5.6.3'
          - task: Bash@3
            displayName: 'Create Results Directories'
            inputs:
              targetType: 'inline'
              script: |
                mkdir -p $(Build.ArtifactStagingDirectory)/jmeter/homepage-dashboard
                mkdir -p $(Build.ArtifactStagingDirectory)/jmeter/login-dashboard
          - task: CmdLine@2
            displayName: 'Run Homepage Test'
            inputs:
              script: |
                jmeter -n -t "$(System.ArtifactsDirectory)/build-outputs/performance-tests/homepage-test.jmx" \
                -l "$(Build.ArtifactStagingDirectory)/jmeter/homepage-results.jtl" \
                -e -o "$(Build.ArtifactStagingDirectory)/jmeter/homepage-dashboard"
          - task: CmdLine@2
            displayName: 'Run Login Test'
            inputs:
              script: |
                jmeter -n -t "$(System.ArtifactsDirectory)/build-outputs/performance-tests/login-test.jmx" \
                -l "$(Build.ArtifactStagingDirectory)/jmeter/login-results.jtl" \
                -e -o "$(Build.ArtifactStagingDirectory)/jmeter/login-dashboard"
          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: '$(Build.ArtifactStagingDirectory)/jmeter'
              artifactName: 'jmeter-results'

# - stage: SecurityScanning
#   displayName: 'Security Scanning'
#   jobs:
#   - job: SecurityCheck
#     displayName: 'Security Check'
#     pool:
#       vmImage: 'ubuntu-latest'

#     steps:
#     - checkout: self
#       fetchDepth: 0

#     # (Optional) still download the build artifacts if you need them later
#     # - task: DownloadBuildArtifacts@0
#     #   displayName: 'Download build outputs'
#     #   inputs:
#     #     buildType: 'current'
#     #     downloadType: 'single'
#     #     artifactName: 'build-outputs'
#     #     downloadPath: '$(System.DefaultWorkingDirectory)'

#     # --- Gitleaks: CredScan replacement ---
#     - task: Gitleaks@3
#       displayName: 'Gitleaks secret scan (CredScan replacement)'
#       inputs:
#         scanlocation: '$(Build.SourcesDirectory)'

#         configtype: 'predefined'
#         predefinedconfigfile: 'GitleaksUdmCombo.toml'

#         scanmode: 'smart'

#         taskfail: false
#         taskfailonexecutionerror: true

#         reportformat: 'sarif'
#         uploadresults: true
#         reportartifactname: 'CodeAnalysisLogs'
#         # reportfolder:  # default: agent temp
#         # reportname:    # default: gitleaks-<timestamp>.sarif

#         redact: true
#         verbose: false

# - stage: DependencySecurity
#   displayName: 'Dependency Security Scanning'
#   jobs:
#   - job: OWASPCheck
#     steps:
#     - task: dependency-check-build-task@6
#       inputs:
#           projectName: '$(Build.Repository.Name)'
#           scanPath: '$(System.DefaultWorkingDirectory)'
#           format: 'HTML'
#           uploadReports: true
#           uploadSARIFReport: true
#           nvdApiKey: '$(NVD_API_KEY)'  # Replace with your API key
#           additionalArguments: >
#             --disableCentral
#             --disableOssIndex